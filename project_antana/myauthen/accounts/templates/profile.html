{% extends 'base.html' %}
{% load static %}

{% block content %}

<body class="min-h-screen bg-white 
  bg-[linear-gradient(to_right,#e5e7eb_1px,transparent_1px),
      linear-gradient(to_bottom,#e5e7eb_1px,transparent_1px)]
  bg-[size:24px_24px]">

  <div class="flex flex-col md:flex-row items-center justify-between gap-6">

    <!-- ‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå + ‡∏ä‡∏∑‡πà‡∏≠ -->
    <div class="flex items-center gap-6">
      <!-- ‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå -->
      {% if user.profile.profile_image %}
      <img src="{{ user.profile.profile_image.url }}" alt="Profile Image"
        class="w-28 h-28 rounded-full object-cover shadow-md ring-4 ring-white dark:ring-slate-900">
      {% else %}
      <div
        class="w-28 h-28 rounded-full bg-gray-300 flex items-center justify-center text-white text-4xl font-bold shadow-md ring-4 ring-white dark:ring-slate-900">
        {{ user.username|slice:":1" }}
      </div>
      {% endif %}

      <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ -->
      <div>
        <h1 class="text-3xl font-semibold text-gray-800 dark:text-white">{{ user.username }}</h1>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">{{ user.posts.count }} ‡πÇ‡∏û‡∏™‡∏ï‡πå</p>
      </div>
    </div>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç -->
    <div>
      <a href="{% url 'edit_profile' %}"
        class="inline-flex items-center gap-2 rounded-full bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 text-sm font-medium shadow transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2"
          viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 1 1 3.536 3.536L8.5 21H4v-4.5L16.732 3.732z" />
        </svg>
        Edit Profile
      </a>
    </div>
  </div>
  </div>


  <main class="flex-1 p-6 overflow-y-auto">
    <h2 class="text-3xl font-bold text-gray-800 mb-6">‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>

    {% if posts %}
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {% for post in posts %}
      <div class="bg-white rounded-lg shadow p-4 relative">
        <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß: ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ + ‡πÄ‡∏°‡∏ô‡∏π -->
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center">
            {% if post.user.profile.profile_image %}
            <img src="{{ post.user.profile.profile_image.url }}" class="w-10 h-10 rounded-full object-cover">
            {% else %}
            <div
              class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center text-sm font-bold text-white">
              {{ post.user.username|slice:":1" }}
            </div>
            {% endif %}
            <div class="ml-3">
              <p class="font-semibold text-gray-800">{{ post.user.username }}</p>
              <p class="text-sm text-gray-500">{{ post.created_at|timesince }} ago</p>
            </div>
          </div>

          <!-- ‡∏õ‡∏∏‡πà‡∏° ‚ãØ -->
          <div class="relative">
            <button onclick="toggleDropdown('dropdown-{{ post.id }}')" class="text-gray-500 hover:text-gray-700">
              ‚ãØ
            </button>

            <!-- ‡πÄ‡∏°‡∏ô‡∏π Dropdown -->
            <div id="dropdown-{{ post.id }}"
              class="hidden absolute right-0 z-10 mt-2 w-40 bg-white border border-gray-200 rounded-lg shadow-lg">
              <a href="{% url 'edit_post' post.id %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏û‡∏™‡∏ï‡πå
              </a>
              </button>
              </form>
            </div>
          </div>
        </div>

        <!-- ‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏û -->
        {% if post.title %}
        <h3 class="text-lg font-bold text-gray-900 mb-1">{{ post.title }}</h3>
        {% endif %}

        <!-- ‡∏Ñ‡∏≥‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢ -->
        <p class="text-gray-700 mb-3 whitespace-pre-line">{{ post.caption }}</p>

        <!-- ‡∏†‡∏≤‡∏û -->
        {% if post.history.image_url %}
        <img src="{{ post.history.image_url }}" alt="Post Image" class="rounded-lg w-full mb-3">
        {% endif %}

        <!-- ‡πÇ‡∏°‡πÄ‡∏î‡∏• -->
        {% if post.model_used %}
        <p class="text-sm text-gray-500 mb-2">üîß ‡πÉ‡∏ä‡πâ‡πÇ‡∏°‡πÄ‡∏î‡∏•: <span class="font-medium">{{ post.model_used }}</span></p>
        {% endif %}

        <!-- ‡πÅ‡∏ó‡πá‡∏Å -->
        {% if post.tags.all %}
        <div class="flex flex-wrap gap-2 mt-2">
          {% for tag in post.tags.all %}
          <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs font-semibold rounded">
            {{ tag.name }} ({{ tag.category }})
          </span>
          {% endfor %}
        </div>
        {% endif %}

        <div class="flex items-center justify-between w-full mt-4 text-gray-500 text-sm">
          <!-- Like -->
          <button id="like-btn-{{ post.id }}" onclick="toggleLike({{ post.id }})"
            class="flex-1 flex justify-center items-center gap-1 hover:text-red-500 {% if request.user in post.likes.all %}text-red-500{% endif %}">
            ‚ù§ <span id="like-count-{{ post.id }}">{{ post.likes.count }}</span>
          </button>

          <!-- Comment -->
          <button onclick="openCommentModal({{ post.id }})"
            class="flex-1 flex justify-center items-center gap-1 hover:text-blue-600">
            üí¨ {{ post.comments.count }}
          </button>

          <!-- Share -->
          <a href="{% url 'share_post' post.history.id %}"
            class="flex-1 flex justify-center items-center gap-1 hover:text-green-600">
            üîó ‡πÅ‡∏ä‡∏£‡πå
          </a>

          <!-- Remix -->
          {% if post.history %}
          <a href="{% url 'generate' %}?prompt={{ post.history.positive_prompt|urlencode }}&negative={{ post.history.negative_prompt|urlencode }}&seed={{ post.history.seed }}&model={{ post.history.model_name|urlencode }}&dimension={{ post.history.dimension.id }}"
            class="flex-1 flex justify-center items-center gap-1 hover:text-purple-600">
            ‚Üª ‡∏£‡∏µ‡∏°‡∏¥‡∏Å‡∏ã‡πå
          </a>
          {% else %}
          <div class="flex-1"></div>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÉ‡∏î ‡πÜ</p>
    {% endif %}
  </main>
  <!-- Comment Modal -->
  <div id="commentModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-70 justify-center items-center p-4">
    <div class="bg-white max-w-5xl w-full rounded-2xl shadow-2xl p-0 relative overflow-hidden flex max-h-[90vh]">
      <button onclick="closeCommentModal()"
        class="absolute top-2 right-2 text-gray-500 hover:text-red-500 z-10 p-2">‚úï</button>
      <div id="commentModalContent" class="w-full flex">Loading...</div>
    </div>
  </div>
  </main>

  </div>
  <script>
    function toggleDropdown(id) {
      const el = document.getElementById(id);
      el.classList.toggle('hidden');
    }

    document.addEventListener('click', function (e) {
      document.querySelectorAll('[id^="dropdown-"]').forEach(function (dropdown) {
        const button = dropdown.previousElementSibling;
        if (!dropdown.contains(e.target) && !button.contains(e.target)) {
          dropdown.classList.add('hidden');
        }
      });
    });
  </script>
  </script>
  <script>
    function openCommentModal(postId) {
      const modal = document.getElementById('commentModal');
      const content = document.getElementById('commentModalContent');

      // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå
      fetch(`/post/${postId}/comment-modal/`)
        .then(response => response.text())
        .then(html => {
          content.innerHTML = html;
          modal.classList.remove('hidden');
          modal.classList.add('flex');
        });
    }

    function closeCommentModal() {
      const modal = document.getElementById('commentModal');
      modal.classList.remove('flex');
      modal.classList.add('hidden');
    }

    async function toggleLike(postId) {
      try {
        // get csrf from hidden input anywhere or cookie
        let token = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value;
        if (!token) {
          // check if there is a csrf in a delete form
          token = document.querySelector(`form[action*="delete"] input[name="csrfmiddlewaretoken"]`)?.value;
        }
        // Fallback if no form found
        if (!token) {
          // Try to find ANY csrf input
          token = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value;
        }

        const res = await fetch(`/post/${postId}/toggle-like/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': token
          }
        });
        const data = await res.json();

        const btn = document.getElementById(`like-btn-${postId}`);
        const span = document.getElementById(`like-count-${postId}`);

        if (btn) {
          if (data.liked) btn.classList.add('text-red-500');
          else btn.classList.remove('text-red-500');
        }
        if (span) span.innerText = data.count;

      } catch (e) { console.error(e); }
    }
  </script>

</body>
{% endblock %}