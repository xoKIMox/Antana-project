{% extends "base.html" %}

{% block content %}
<div class="container" style="max-width: 1000px; margin: 20px auto;">

    <!-- หัวข้อหน้า -->
    <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 20px;">
        {{ title|default:"จัดการสมาชิก (Members)" }}
    </h2>

    <!-- แสดง message ต่าง ๆ -->
    {% if messages %}
    <div style="margin-bottom: 15px;">
        {% for message in messages %}
        <div style="
                    padding: 8px 12px;
                    border-radius: 4px;
                    margin-bottom: 5px;
                    font-size: 14px;
                    {% if message.tags == 'error' %}
                        background-color: #ffe5e5;
                        color: #b00020;
                    {% else %}
                        background-color: #e6ffed;
                        color: #1b5e20;
                    {% endif %}
                ">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- กล่องตารางเหมือนหน้า Custom Model -->
    <div style="
        background-color: #ffffff;
        border-radius: 12px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.06);
        overflow: hidden;
        border: 1px solid #e5e7eb;
    ">
        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
            <thead>
                <tr style="background-color: #f9fafb;">
                    <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #4b5563;">
                        Username
                    </th>
                    <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #4b5563;">
                        Email
                    </th>
                    <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #4b5563;">
                        Role
                    </th>
                    <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #4b5563;">
                        Status
                    </th>
                    <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #4b5563;">
                        Operations
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for u in users %}
                <tr style="border-top: 1px solid #e5e7eb;">
                    <!-- Username -->
                    <td style="padding: 10px 16px; color: #111827;">
                        {{ u.username }}
                    </td>

                    <!-- Email -->
                    <td style="padding: 10px 16px; color: #374151;">
                        {{ u.email|default:"-" }}
                    </td>

                    <!-- Role -->
                    <td style="padding: 10px 16px; color: #374151;">
                        {% if u.is_staff %}
                        แอดมิน
                        {% else %}
                        ผู้ใช้ทั่วไป
                        {% endif %}
                    </td>

                    <!-- Status -->
                    <td style="padding: 10px 16px;">
                        {% if u.is_active %}
                        <span style="color: #16a34a; font-weight: 600;">Active</span>
                        {% else %}
                        <span style="color: #b91c1c; font-weight: 600;">Inactive</span>
                        {% endif %}
                    </td>

                    <!-- Operations -->
                    <td style="padding: 10px 16px; color: #2563eb;">
                        <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                            <!-- ปุ่มสลับ Active -->
                            <form method="post" action="{% url 'admin_toggle_user_active' u.id %}"
                                style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" class="link-btn" style="
                                        background: none;
                                        border: none;
                                        padding: 0;
                                        margin: 0;
                                        font: inherit;
                                        cursor: pointer;
                                        color: #2563eb;
                                    ">
                                    {% if u.is_active %}
                                    Deactivate
                                    {% else %}
                                    Activate
                                    {% endif %}
                                </button>
                            </form>

                            <!-- คั่นกลาง -->
                            <span>|</span>

                            <!-- ปุ่มสลับสิทธิ์แอดมิน -->
                            <form method="post" action="{% url 'admin_toggle_user_staff' u.id %}"
                                style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" class="link-btn" style="
                                        background: none;
                                        border: none;
                                        padding: 0;
                                        margin: 0;
                                        font: inherit;
                                        cursor: pointer;
                                        color: #2563eb;
                                    ">
                                    {% if u.is_staff %}
                                    Remove Admin
                                    {% else %}
                                    Make Admin
                                    {% endif %}
                                </button>
                            </form>

                            <!-- คั่นกลาง -->
                            {% if request.user.id != u.id %}
                            <span>|</span>

                            <!-- ปุ่มลบ -->
                            <form method="post" action="{% url 'admin_delete_user' u.id %}" style="display:inline;"
                                onsubmit="return confirm('ยืนยันการลบบัญชี {{ u.username }} ?');">
                                {% csrf_token %}
                                <button type="submit" class="link-btn" style="
                                            background: none;
                                            border: none;
                                            padding: 0;
                                            margin: 0;
                                            font: inherit;
                                            cursor: pointer;
                                            color: #dc2626;
                                        ">
                                    Delete
                                </button>
                            </form>
                            {% else %}
                            <span style="font-size: 11px; color: #9ca3af;">
                                (ไม่สามารถลบบัญชีตัวเอง)
                            </span>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" style="padding: 16px; text-align: center; color: #6b7280;">
                        ยังไม่มีสมาชิกในระบบ
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% include 'pagination.html' %}

    <!-- ปุ่มด้านล่างซ้าย -->
    <div class="mt-6">
        <button type="button" onclick="openAddUserModal()"
            class="bg-gray-900 text-white px-4 py-2 rounded-lg shadow hover:bg-black transition">
            + Add New Member
        </button>
    </div>
</div>

<!-- Modal เพิ่มสมาชิก -->
<div id="addUserModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center z-50">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative">
        <h3 class="text-xl font-bold mb-4 text-gray-800">เพิ่มสมาชิกใหม่</h3>

        <form method="post" action="{% url 'admin_add_user' %}" onsubmit="return validateAddUserForm()">
            {% csrf_token %}

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                <input type="text" name="username" required
                    class="w-full border border-gray-300 rounded px-3 py-2 focus:ring focus:ring-blue-200 focus:border-blue-500">
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                <input type="email" name="email" required
                    class="w-full border border-gray-300 rounded px-3 py-2 focus:ring focus:ring-blue-200 focus:border-blue-500">
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                <input type="password" name="password" id="new_password" required minlength="8"
                    class="w-full border border-gray-300 rounded px-3 py-2 focus:ring focus:ring-blue-200 focus:border-blue-500">
                <p class="text-xs text-gray-500 mt-1">* ต้องมีความยาวอย่างน้อย 8 ตัวอักษรและมีตัวเลข</p>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
                <input type="password" name="confirm_password" id="confirm_password" required
                    class="w-full border border-gray-300 rounded px-3 py-2 focus:ring focus:ring-blue-200 focus:border-blue-500">
            </div>

            <div class="flex justify-end gap-2">
                <button type="button" onclick="closeAddUserModal()"
                    class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300">
                    ยกเลิก
                </button>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-bold">
                    สร้างสมาชิก
                </button>
            </div>
        </form>

        <button onclick="closeAddUserModal()" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600">
            ✕
        </button>
    </div>
</div>

<script>
    function openAddUserModal() {
        document.getElementById('addUserModal').classList.remove('hidden');
    }

    function closeAddUserModal() {
        document.getElementById('addUserModal').classList.add('hidden');
    }

    function validateAddUserForm() {
        const password = document.getElementById('new_password').value;
        const confirm = document.getElementById('confirm_password').value;

        if (password !== confirm) {
            alert("รหัสผ่านไม่ตรงกัน");
            return false;
        }

        if (password.length < 8) {
            alert("รหัสผ่านต้องมีความยาวอย่างน้อย 8 ตัวอักษร");
            return false;
        }

        // Check for at least one number
        if (!/\d/.test(password)) {
            alert("รหัสผ่านต้องมีตัวเลขอย่างน้อย 1 ตัว");
            return false;
        }

        return true;
    }
</script>
{% endblock %}