<div class="flex flex-col md:flex-row h-full max-h-[90vh]">
  <!-- Left Side: Image -->
  <div class="w-full md:w-[60%] bg-black flex items-center justify-center relative bg-pattern-grid">
    {% if post.history.image_url %}
    <img src="{{ post.history.image_url }}" class="max-w-full max-h-[40vh] md:max-h-full object-contain">
    {% else %}
    <div class="text-gray-500">No Image Available</div>
    {% endif %}
  </div>

  <!-- Right Side: Comments & Info -->
  <div class="w-full md:w-[40%] flex flex-col h-full bg-white border-l">

    <!-- 1. Header -->
    <div class="p-4 border-b flex items-center justify-between shrink-0">
      <div class="flex items-center gap-3">
        {% if post.user.profile.profile_image %}
        <img src="{{ post.user.profile.profile_image.url }}" class="w-10 h-10 rounded-full object-cover border">
        {% else %}
        <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center text-white font-bold text-lg">
          {{ post.user.username|slice:":1" }}
        </div>
        {% endif %}
        <div>
          <a href="{% url 'user_profile' post.user.username %}"
            class="font-bold hover:underline text-gray-900 block leading-tight">
            {{ post.user.username }}
          </a>
          <span class="text-xs text-gray-500">{{ post.created_at|timesince }} ago</span>
        </div>
      </div>

      <!-- Close Button (Mobile Only, since Desktop has outside button) -->
      <button onclick="closeCommentModal()" class="md:hidden text-gray-500 text-2xl">&times;</button>
    </div>

    <!-- 2. Scrollable Content (Caption + Comments) -->
    <div class="flex-1 overflow-y-auto p-4 space-y-4">

      <!-- Caption Section -->
      <div class="flex gap-3 mb-6">
        <div class="shrink-0 pt-1">
          {% if post.user.profile.profile_image %}
          <img src="{{ post.user.profile.profile_image.url }}" class="w-8 h-8 rounded-full object-cover">
          {% else %}
          <div class="w-8 h-8 rounded-full bg-gray-300"></div>
          {% endif %}
        </div>
        <div>
          <div class="text-sm">
            <span class="font-bold mr-1">{{ post.user.username }}</span>
            <span class="text-gray-800">{{ post.caption }}</span>
          </div>
          {% if post.title %} <div class="text-xs font-semibold text-gray-500 mt-1">{{ post.title }}</div> {% endif %}
          <div class="text-xs text-gray-400 mt-2">
            {% for tag in post.tags.all %}
            <span class="mr-1 text-blue-500">#{{ tag.name }}</span>
            {% endfor %}
          </div>
        </div>
      </div>

      <hr class="border-gray-100 my-2">

      <!-- Comments List -->
      {% if comments %}
      {% for comment in comments %}
      <div class="flex gap-3 group relative">
        <div class="shrink-0">
          {% if comment.user.profile.profile_image %}
          <img src="{{ comment.user.profile.profile_image.url }}" class="w-8 h-8 rounded-full object-cover">
          {% else %}
          <div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-white text-xs font-bold">
            {{ comment.user.username|slice:":1" }}
          </div>
          {% endif %}
        </div>
        <div class="flex-1">
          <!-- Normal Display View -->
          <div id="comment-view-{{ comment.id }}">
            <div class="text-sm">
              <span class="font-bold mr-1">{{ comment.user.username }}</span>
              <span class="text-gray-700 whitespace-pre-line">{{ comment.text }}</span>
            </div>
            <div class="flex items-center gap-3 mt-1 text-xs text-gray-400">
              <span>{{ comment.created_at|timesince }}</span>
            </div>
          </div>

          <!-- Edit Form (Hidden by default) -->
          <form id="comment-edit-form-{{ comment.id }}" action="{% url 'edit_comment' comment.id %}" method="POST"
            class="hidden mt-2">
            {% csrf_token %}
            <textarea name="text" rows="2"
              class="w-full text-sm border rounded p-2 focus:ring-blue-500 focus:border-blue-500">{{ comment.text }}</textarea>
            <div class="flex gap-2 mt-2 justify-end">
              <button type="button" onclick="cancelEditComment({{ comment.id }})"
                class="text-xs text-gray-500 hover:text-gray-700">Cancel</button>
              <button type="submit"
                class="text-xs bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">Save</button>
            </div>
          </form>
        </div>

        <!-- 3-Dot Menu (Owner/Staff only) -->
        {% if request.user == comment.user or request.user.is_staff or request.user.is_superuser %}
        <div class="absolute top-0 right-0">
          <button onclick="toggleCommentMenu({{ comment.id }})"
            class="text-gray-400 hover:text-gray-600 p-1 opacity-0 group-hover:opacity-100 transition-opacity">
            ‚ãÆ
          </button>

          <!-- Dropdown Menu -->
          <div id="comment-menu-{{ comment.id }}"
            class="hidden absolute right-0 mt-1 w-24 bg-white border rounded shadow-lg z-10">
            <button onclick="editComment({{ comment.id }})"
              class="block w-full text-left px-3 py-1.5 text-xs hover:bg-gray-100">
              ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            </button>
            <button onclick="deleteComment({{ comment.id }})"
              class="block w-full text-left px-3 py-1.5 text-xs text-red-600 hover:bg-red-50">
              ‡∏•‡∏ö
            </button>
          </div>

          <!-- Hidden Delete Form -->
          <form id="comment-delete-form-{{ comment.id }}" action="{% url 'delete_comment' comment.id %}" method="POST"
            class="hidden">
            {% csrf_token %}
          </form>
        </div>
        {% endif %}
      </div>
      {% endfor %}
      {% else %}
      <div class="flex flex-col items-center justify-center h-40 text-gray-400 text-sm">
        <span class="text-2xl mb-2">üí¨</span>
        <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</p>
        <p>‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å!</p>
      </div>
      {% endif %}
    </div>

    <!-- 3. Footer: Input Form -->
    <div class="p-3 border-t bg-white shrink-0">
      <form method="POST" action="{% url 'add_comment' post.id %}" class="flex items-center gap-2">
        {% csrf_token %}
        <input type="text" name="text" required
          class="flex-1 bg-gray-50 border-none rounded-full px-4 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none"
          placeholder="‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô...">
        <button type="submit" class="text-blue-600 font-bold text-sm px-2 hover:text-blue-800">
          ‡πÇ‡∏û‡∏™‡∏ï‡πå
        </button>
      </form>
    </div>

  </div>
</div>